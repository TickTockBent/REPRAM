version: '3.8'

services:
  node1:
    build: .
    ports:
      - "8081:8080"
      - "9091:9090"
    environment:
      - REPRAM_NODE_ID=node1
      - REPRAM_ADDRESS=node1
      - REPRAM_HTTP_PORT=8080
      - REPRAM_GOSSIP_PORT=9090
      - REPRAM_NETWORK=private
      - REPRAM_PEERS=node2:8080,node3:8080
      - REPRAM_REPLICATION=3
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - repram-net

  node2:
    build: .
    ports:
      - "8082:8080"
      - "9092:9090"
    environment:
      - REPRAM_NODE_ID=node2
      - REPRAM_ADDRESS=node2
      - REPRAM_HTTP_PORT=8080
      - REPRAM_GOSSIP_PORT=9090
      - REPRAM_NETWORK=private
      - REPRAM_PEERS=node1:8080,node3:8080
      - REPRAM_REPLICATION=3
    depends_on:
      - node1
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - repram-net

  node3:
    build: .
    ports:
      - "8083:8080"
      - "9093:9090"
    environment:
      - REPRAM_NODE_ID=node3
      - REPRAM_ADDRESS=node3
      - REPRAM_HTTP_PORT=8080
      - REPRAM_GOSSIP_PORT=9090
      - REPRAM_NETWORK=private
      - REPRAM_PEERS=node1:8080,node2:8080
      - REPRAM_REPLICATION=3
    depends_on:
      - node1
      - node2
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - repram-net

networks:
  repram-net:
    driver: bridge
